<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bombardo v5.3</title>
    <style>
        /* --- LAYOUT PRINCIPAL --- */
        body {
            margin: 0; padding: 0; background-color: #111;
            height: 100vh; width: 100vw;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; touch-action: none; font-family: 'Courier New', monospace;
            user-select: none; -webkit-user-select: none;
        }

        /* --- PUBLICIDAD --- */
        #ad-container {
            width: 100%; max-width: 728px; min-height: 90px; 
            background-color: #1a1a1a; margin-bottom: 5px;
            display: flex; justify-content: center; align-items: center;
            border-bottom: 1px solid #333; box-sizing: border-box; flex-shrink: 0; overflow: hidden;
        }
        @media (max-height: 600px) { #ad-container { display: none; } }

        /* --- HUD --- */
        #hud-container {
            width: 100%; max-width: 480px; display: none; flex-direction: column; margin-bottom: 4px;
        }
        #hud { 
            display: flex; width: 100%; justify-content: space-between; align-items: center;
            padding: 4px 0; background-color: #1a1a1a; box-sizing: border-box; border-bottom: 2px solid #333;
        }
        #stats-bar {
            display: flex; justify-content: space-around; background: #222; color: #f1c40f; 
            font-size: 10px; padding: 2px; border: 1px solid #444; border-top: none;
        }
        .stat-item { display: flex; align-items: center; gap: 4px; }
        
        /* CLASE GENÃ‰RICA PARA ICONOS (HUD Y SETTINGS) */
        /* Sheet 224x160. Escala 0.5x para UI = 112x80 */
        /* Fila 5 (y=128px) -> Scaled y=64px */
        /* A5(0,64), B5(16,64), C5(32,64) */
        .ui-icon { 
            width: 16px; height: 16px; display: inline-block; vertical-align: middle;
            background-image: url('sprites.png'); 
            background-size: 112px 80px; 
            image-rendering: pixelated; 
        }
        .icon-fire { background-position: 0 -64px; }       /* A5 */
        .icon-bomb { background-position: -16px -64px; }   /* B5 */
        .icon-speed { background-position: -32px -64px; }  /* C5 */
        
        .score-box { 
            background: #2c3e50; padding: 4px 2px; color: white; font-weight: bold; 
            border: 1px solid #444; font-size: 10px; text-shadow: 1px 1px 0 #000; 
            margin: 0 1px; text-align: center; flex: 1; white-space: nowrap; overflow: hidden; border-radius: 4px;
        }
        #timer-box { color: #fff; border: 1px solid #f1c40f; flex: 0 0 40px; background: #222; }

        /* VIEWPORT */
        #game-viewport {
            position: relative; background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); 
            width: 480px; height: 352px; flex-shrink: 1; 
            display: flex; justify-content: center; align-items: center; overflow: hidden; border: 2px solid #333;
        }
        canvas { display: block; width: 100%; height: 100%; image-rendering: pixelated; }
        
        /* UI SCREENS */
        .screen-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.9); z-index: 100;
        }
        .panel { 
            background: #2c3e50; border: 4px solid #fff; padding: 15px; text-align: center; 
            min-width: 280px; box-sizing: border-box; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            max-height: 95vh; overflow-y: auto;
        }
        h1 { color: #f1c40f; margin: 0 0 10px 0; font-size: 24px; text-shadow: 2px 2px #c0392b; }
        
        input, select { 
            padding: 8px; background: #000; color: #fff; border: 2px solid #555; 
            text-align: center; display: block; margin: 0 auto 10px auto; width: 150px; font-size: 14px; 
        }
        button { 
            padding: 10px 20px; background: #e74c3c; color: white; border: 2px solid #fff; 
            font-weight: bold; width: 100%; font-size: 14px; cursor: pointer; margin-top: 5px; 
        }
        button:active { transform: scale(0.95); background: #c0392b; }
        button:disabled { background: #555; color: #888; border-color: #555; cursor: not-allowed; }
        #btnReady { background: #2ecc71; margin-top: 10px; }
        #btnReady.is-ready { background: #7f8c8d; }
        #login-log { font-size: 10px; color: #aaa; margin-top: 10px; min-height: 14px; max-width: 260px; word-wrap: break-word;}

        /* LOBBY */
        .lobby-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; }
        .player-slot { 
            background: #333; padding: 8px; border: 2px solid #555; 
            color: #777; font-size: 11px; font-weight: bold; text-shadow: 1px 1px 0 #000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            position: relative; min-height: 45px;
        }
        .player-slot.active { border-color: #fff; color: #fff; }
        .ready-badge { position: absolute; bottom: 2px; right: 2px; font-size: 12px; color: #2ecc71; display: none; text-shadow: 0 0 2px #000; }
        .player-slot.ready .ready-badge { display: block; }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: #555; position: absolute; top: 4px; right: 4px; border: 1px solid #fff; }
        .status-dot.connected { background: #2ecc71; }
        
        .player-slot.p1.active { background: #ac3232; } 
        .player-slot.p2.active { background: #3498db; } 
        .player-slot.p3.active { background: #f1c40f; } 
        .player-slot.p4.active { background: #9b59b6; } 

        /* SETTINGS & PROFILE */
        #host-settings {
            background: #222; border: 1px dashed #f1c40f; padding: 8px; margin-bottom: 10px;
            text-align: left; font-size: 11px; display: none;
        }
        .setting-row { margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center; }
        .mini-checks { display: flex; gap: 15px; justify-content: center; margin-top: 5px; }
        .mini-checks label { display: flex; align-items: center; gap: 4px; cursor: pointer; color: #ccc; }
        
        #profile-editor { background: #34495e; padding: 8px; margin-bottom: 10px; border: 1px dashed #7f8c8d; transition: opacity 0.3s; }
        #profile-editor.locked { opacity: 0.5; pointer-events: none; }
        .color-palette { display: flex; justify-content: center; gap: 5px; margin-top: 5px; }
        .color-btn { width: 20px; height: 20px; border: 2px solid #000; cursor: pointer; transition: transform 0.1s; }
        .color-btn:hover { transform: scale(1.1); }
        .color-btn.selected { border-color: #fff; box-shadow: 0 0 5px #fff; transform: scale(1.2); z-index: 2; }
        .color-btn.taken { opacity: 0.2; cursor: not-allowed; }

        /* CONTROLS */
        #gamepad-area {
            display: none; width: 100%; min-height: 240px; 
            background: #1a1a1a; border-top: 4px solid #333;
            flex-direction: row; justify-content: space-between; align-items: flex-start;
            padding: 20px 30px; padding-bottom: max(20px, env(safe-area-inset-bottom)); box-sizing: border-box; flex-shrink: 0;
        }
        .gp-btn { position: absolute; background-image: url('sprites.png'); background-repeat: no-repeat; image-rendering: pixelated; }
        .gp-btn:active { filter: brightness(1.2); transform: scale(0.95); }
        .d-pad { position: relative; width: 180px; height: 180px; }
        .arrow-btn { width: 64px; height: 64px; background-size: 448px 320px; background-position: -128px -192px; } 
        #btn-up { left: 58px; top: 0; } #btn-down { left: 58px; bottom: 0; transform: rotate(180deg); }
        #btn-left { left: 0; top: 58px; transform: rotate(-90deg); } #btn-right { right: 0; top: 58px; transform: rotate(90deg); }
        #action-wrapper { position: relative; width: 120px; height: 120px; display: flex; justify-content: center; align-items: center; margin-top: 20px; }
        #action-btn { position: relative; width: 80px; height: 80px; background-size: 560px 400px; background-position: -160px -80px; background-color: #c0392b; border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); box-shadow: 0 8px 0 #000; }
        #action-btn:active { box-shadow: 0 4px 0 #000; transform: translateY(4px); }

        #game-over-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 50; }
    </style>
</head>
<body>

    <div id="ad-container">
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4325671609150427" crossorigin="anonymous"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-4325671609150427" data-ad-slot="2531602052" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
    </div>

    <div id="hud-container">
        <div id="hud">
            <div id="timer-box" class="score-box">120</div>
            <div id="p1-score" class="score-box">P1: 0</div>
            <div id="p2-score" class="score-box">P2: 0</div>
            <div id="p3-score" class="score-box" style="display:none;">P3: 0</div>
            <div id="p4-score" class="score-box" style="display:none;">P4: 0</div>
        </div>
        <div id="stats-bar">
            <div class="stat-item"><div class="ui-icon icon-bomb"></div> <span id="stat-bomb">1</span></div>
            <div class="stat-item"><div class="ui-icon icon-fire"></div> <span id="stat-fire">2</span></div>
            <div class="stat-item"><div class="ui-icon icon-speed"></div> <span id="stat-speed">2</span></div>
        </div>
    </div>

    <div id="game-viewport">
        <canvas id="gameCanvas"></canvas>
        <div id="game-over-overlay" style="display:none;">
            <h1 id="winner-text" style="font-size: 40px; color: #f1c40f;">GANADOR</h1>
            <p id="winner-reason" style="color: white; margin-top:0;">...</p>
            <button onclick="location.reload()" style="width: auto; padding: 10px 30px;">REINICIAR</button>
        </div>
        <div id="screen-loading" class="screen-layer"><h1 style="color:white;">CARGANDO...</h1></div>
        <div id="screen-login" class="screen-layer" style="display:none;">
            <div class="panel">
                <h1>Bombardo!ðŸ’£ (v5.3)</h1>
                <div style="font-size:10px; margin-bottom:10px; color:#ccc;">Desarrollado por: Steven Arias</div>
                <input type="text" id="roomInput" placeholder="ID SALA" value="TEST" maxlength="6">
                <button id="btnConnect" onclick="connectToServer()">CONECTAR</button>
                <div id="login-log">Desconectado</div>
            </div>
        </div>
        <div id="screen-lobby" class="screen-layer" style="display:none;">
            <div class="panel">
                <h1 style="font-size:20px; margin-bottom: 5px;">SALA DE ESPERA</h1>
                
                <div id="host-settings">
                    <div class="setting-row">
                        <label>Mapa:</label>
                        <select id="set-level" style="padding: 2px; width: 90px;">
                            <option value="0">Aleatorio</option>
                            <option value="1">Pasto</option>
                            <option value="2">Madera</option>
                        </select>
                    </div>
                    <div class="setting-row">
                        <label>Items:</label>
                        <select id="set-density" style="padding: 2px; width: 90px;">
                            <option value="0.1">Pocos</option>
                            <option value="0.25" selected>Normal</option>
                            <option value="0.5">Muchos</option>
                        </select>
                    </div>
                    <div class="mini-checks">
                        <label><input type="checkbox" id="chk-bomb" checked><div class="ui-icon icon-bomb"></div></label>
                        <label><input type="checkbox" id="chk-fire" checked><div class="ui-icon icon-fire"></div></label>
                        <label><input type="checkbox" id="chk-speed" checked><div class="ui-icon icon-speed"></div></label>
                    </div>
                </div>

                <div id="profile-editor">
                    <div style="font-size: 10px; color: #ccc; margin-bottom: 5px;">MI PERFIL</div>
                    <input type="text" id="my-name-input" placeholder="NOMBRE" maxlength="5" style="width: 100px; padding: 5px; margin-bottom: 5px;">
                    <div class="color-palette" id="color-palette"></div>
                </div>
                <button id="btnReady" onclick="toggleReady()">Â¡ESTOY LISTO!</button>
                <div class="lobby-grid" style="margin-top:10px;">
                    <div id="slot-1" class="player-slot">P1 (HOST)<div class="status-dot"></div><span class="ready-badge">âœ”</span></div>
                    <div id="slot-2" class="player-slot">P2: ...<div class="status-dot"></div><span class="ready-badge">âœ”</span></div>
                    <div id="slot-3" class="player-slot">P3: ...<div class="status-dot"></div><span class="ready-badge">âœ”</span></div>
                    <div id="slot-4" class="player-slot">P4: ...<div class="status-dot"></div><span class="ready-badge">âœ”</span></div>
                </div>
                <button id="btnStartGame" onclick="hostStartGame()" disabled style="display:none; background:#f1c40f; color:#000;">INICIAR</button>
                <div style="font-size:10px; margin-top:5px; color:#aaa;" id="lobby-msg">Esperando...</div>
            </div>
        </div>
    </div>

    <div id="gamepad-area">
        <div class="d-pad">
            <div id="btn-up" class="gp-btn arrow-btn"></div>
            <div id="btn-down" class="gp-btn arrow-btn"></div>
            <div id="btn-left" class="gp-btn arrow-btn"></div>
            <div id="btn-right" class="gp-btn arrow-btn"></div>
        </div>
        <div id="action-wrapper"><div id="action-btn" class="gp-btn"></div></div>
    </div>

<script>
const CONFIG={TILE:32,COLS:15,ROWS:11,WIDTH:480,HEIGHT:352,SPEED_BASE:2,BRICK_DENSITY:0.6,BOMB_RANGE_BASE:2,MAX_BOMBS_BASE:1,WIN_SCORE:3,ROUND_TIME:120};
// Sprites Mapping (Fila 5 es y=4)
const SPRITES={
    ITEM_FIRE:{x:0,y:4},ITEM_BOMB:{x:1,y:4},ITEM_SPEED:{x:2,y:4}, // A5, B5, C5
    L1:{FLOOR:{x:0,y:1},WALL_S:{x:0,y:0},WALL_B:{x:1,y:0}}, 
    L2:{FLOOR:{x:1,y:1},WALL_S:{x:2,y:0},WALL_B:{x:6,y:4}},
    BOMB_IDLE:[{x:0,y:2},{x:1,y:2}],EXPLOSION_ANIM:[{x:3,y:4},{x:4,y:4}], // D5, E5
    CHAR:{IDLE_DOWN:[{x:3,y:0}],WALK_DOWN:[{x:4,y:0},{x:3,y:0},{x:5,y:0}],IDLE_SIDE:[{x:6,y:0}],WALK_SIDE:[{x:3,y:1},{x:4,y:1},{x:5,y:1}],IDLE_UP:[{x:3,y:2}],WALK_UP:[{x:4,y:2},{x:3,y:2},{x:5,y:2}],DIE:[{x:6,y:2},{x:3,y:3},{x:4,y:3},{x:5,y:3}]}
};
const ICE_SERVERS={iceServers:[{urls:'stun:stun.l.google.com:19302'},{urls:'stun:stun1.l.google.com:19302'},{urls:'stun:stun2.l.google.com:19302'}],iceCandidatePoolSize:10};
const PALETTE=[{name:'Red',hex:'#ac3232',filter:'none'},{name:'Blue',hex:'#3498db',filter:'hue-rotate(210deg) brightness(1.2)'},{name:'Green',hex:'#2ecc71',filter:'hue-rotate(120deg) brightness(1.2)'},{name:'Yellow',hex:'#f1c40f',filter:'hue-rotate(60deg) brightness(1.5)'},{name:'Purple',hex:'#9b59b6',filter:'hue-rotate(290deg) brightness(1.1)'},{name:'Cyan',hex:'#00cec9',filter:'hue-rotate(180deg) brightness(1.3)'}];
const assets={spritesheet:new Image(),coloredSheets:[],loaded:false};
function loadAssets(){assets.spritesheet.src='sprites.png';assets.spritesheet.onload=()=>{generateColoredSprites();assets.loaded=true;console.log("OK");showLoginScreen();};assets.spritesheet.onerror=()=>{console.warn("Err");assets.loaded=false;showLoginScreen();};}
function generateColoredSprites(){PALETTE.forEach((pal,idx)=>{const c=document.createElement('canvas');c.width=assets.spritesheet.width;c.height=assets.spritesheet.height;const ctx=c.getContext('2d');ctx.imageSmoothingEnabled=false;if(pal.filter!=='none')ctx.filter=pal.filter;ctx.drawImage(assets.spritesheet,0,0);assets.coloredSheets[idx]=c;});}
function showLoginScreen(){document.getElementById('screen-loading').style.display='none';document.getElementById('screen-login').style.display='flex';init();initUI();}

let mapGrid=[], bombs=[], explosions=[], items=[];
const TILE_TYPE={EMPTY:0,WALL:1,BRICK:2,BOMB:3}; const ITEM_TYPE={NONE:0,FIRE:1,BOMB:2,SPEED:3};
let currentLevel=1;
const state={status:'LOGIN',input:{x:0,y:0,active:false},localPlayer:null,players:{},lobbyPlayers:{},frame:0,scores:{1:0,2:0,3:0,4:0},processingDeath:false,winner:null,timeLeft:CONFIG.ROUND_TIME};
let myProfile={name:'',colorIdx:0,isReady:false};

function initUI(){
    const inp=document.getElementById('my-name-input'); inp.replaceWith(inp.cloneNode(true));
    document.getElementById('my-name-input').addEventListener('input',(e)=>{if(myProfile.isReady)return;myProfile.name=e.target.value.toUpperCase();if(net.id)sendProfileUpdate();});
    updatePaletteUI();
}
function updatePaletteUI(){
    const taken=new Set(); for(let p in state.lobbyPlayers)if(parseInt(p)!==net.id)taken.add(state.lobbyPlayers[p].colorIdx);
    const c=document.getElementById('color-palette'); c.innerHTML='';
    PALETTE.forEach((col,idx)=>{const d=document.createElement('div');d.className='color-btn';d.style.backgroundColor=col.hex;if(idx===myProfile.colorIdx)d.classList.add('selected');if(taken.has(idx))d.classList.add('taken');else d.onclick=()=>{if(!myProfile.isReady)setLocalColor(idx);};c.appendChild(d);});
}
function setLocalColor(idx){for(let p in state.lobbyPlayers)if(parseInt(p)!==net.id && state.lobbyPlayers[p].colorIdx===idx)return;myProfile.colorIdx=idx;updatePaletteUI();if(net.id)sendProfileUpdate();}
function toggleReady(){if(!net.id||net.id===1)return;myProfile.isReady=!myProfile.isReady;const b=document.getElementById('btnReady'),e=document.getElementById('profile-editor');if(myProfile.isReady){b.innerText="CANCELAR";b.classList.add('is-ready');e.classList.add('locked');document.getElementById('my-name-input').disabled=true;}else{b.innerText="LISTO";b.classList.remove('is-ready');e.classList.remove('locked');document.getElementById('my-name-input').disabled=false;}sendProfileUpdate();}
function sendProfileUpdate(){net.send({t:'profile_update',id:net.id,name:myProfile.name||`P${net.id}`,cIdx:myProfile.colorIdx,rdy:myProfile.isReady});updateLobbyData(net.id,myProfile.name||`P${net.id}`,myProfile.colorIdx,myProfile.isReady);}
function updateLobbyData(id,name,colorIdx,isReady){
    state.lobbyPlayers[id]={name,colorIdx,isReady};renderLobbySlots();updatePaletteUI();
    if(net.id===1){const b=document.getElementById('btnStartGame');const o=Object.keys(state.lobbyPlayers).filter(p=>p!=1);const r=o.length>0&&o.every(p=>state.lobbyPlayers[p].isReady);if(r||o.length===0){b.disabled=false;b.style.opacity="1";}else{b.disabled=true;b.style.opacity="0.5";}}
    if(state.players[id]){state.players[id].name=name;state.players[id].colorIdx=colorIdx;}
}
function renderLobbySlots(){
    for(let i=1;i<=4;i++){
        const s=document.getElementById(`slot-${i}`),d=s.querySelector('.status-dot'),p=state.lobbyPlayers[i];
        d.className='status-dot'; s.className='player-slot '+(i===1?'p1':(i===2?'p2':(i===3?'p3':'p4')));
        if(p){s.classList.add('active');s.childNodes[0].nodeValue=`${p.name} ${i===1?'(HOST)':''}`;const c=PALETTE[p.colorIdx]||PALETTE[0];s.style.backgroundColor=c.hex;s.style.color=(p.colorIdx===3||p.colorIdx===5)?'#000':'#fff';if(p.isReady||i===1)s.classList.add('ready');else s.classList.remove('ready');if(i===net.id||(net.peers[i]&&net.peers[i].rtc.connectionState==='connected'))d.classList.add('connected');}
        else{s.classList.remove('active','ready');s.style.backgroundColor='#333';s.style.color='#777';s.childNodes[0].nodeValue=`P${i}: ...`;}
    }
    for(let i=1;i<=4;i++){const p=state.lobbyPlayers[i],e=document.getElementById(`p${i}-score`);if(p){e.innerText=`${p.name}: ${state.scores[i]||0}`;e.style.color=PALETTE[p.colorIdx].hex;}else e.style.display='none';}
}
function updateStatsUI(){if(!state.localPlayer)return;document.getElementById('stat-bomb').innerText=state.localPlayer.stats.maxBombs;document.getElementById('stat-fire').innerText=state.localPlayer.stats.range;document.getElementById('stat-speed').innerText=state.localPlayer.stats.speed;}

class Net{
    constructor(){this.ws=null;this.id=0;this.peers={};}
    connect(r){log("Conectando...");this.ws=new WebSocket('wss://bomber-server.onrender.com');this.ws.onopen=()=>{log("WS OK");this.ws.send(JSON.stringify({type:'join',room:r}));};this.ws.onmessage=e=>this.handle(JSON.parse(e.data));this.ws.onerror=()=>log("Error WS");}
    async handle(m){
        switch(m.type){
            case 'id':this.id=m.id;if(!myProfile.name){myProfile.name=`P${m.id}`;document.getElementById('my-name-input').value=myProfile.name;}myProfile.colorIdx=(m.id-1)%PALETTE.length;if(m.id===1){document.getElementById('btnReady').style.display='none';document.getElementById('host-settings').style.display='block';}enterLobby(m.id);break;
            case 'peer_connected':this.initRTC(m.id,true);break;
            case 'offer':if(!this.peers[m.origin])this.initRTC(m.origin,false);await this.peers[m.origin].rtc.setRemoteDescription(m.sdp);if(this.peers[m.origin].pendingCandidates){for(let c of this.peers[m.origin].pendingCandidates)await this.peers[m.origin].rtc.addIceCandidate(c);this.peers[m.origin].pendingCandidates=[];}setTimeout(async()=>{const a=await this.peers[m.origin].rtc.createAnswer();await this.peers[m.origin].rtc.setLocalDescription(a);this.sig({type:'answer',sdp:a,target:m.origin});},500);break;
            case 'answer':if(this.peers[m.origin])await this.peers[m.origin].rtc.setRemoteDescription(m.sdp);break;
            case 'candidate':if(this.peers[m.origin]){const p=this.peers[m.origin];if(p.rtc.remoteDescription)await p.rtc.addIceCandidate(m.candidate);else{if(!p.pendingCandidates)p.pendingCandidates=[];p.pendingCandidates.push(m.candidate);}}break;
        }
    }
    sig(d){if(this.ws)this.ws.send(JSON.stringify(d));}
    initRTC(peerId,offerer){
        const rtc=new RTCPeerConnection(ICE_SERVERS);this.peers[peerId]={rtc:rtc,ch:null,pendingCandidates:[]};
        rtc.onicecandidate=e=>{if(e.candidate)this.sig({type:'candidate',candidate:e.candidate,target:peerId});};
        rtc.onconnectionstatechange=()=>{if(rtc.connectionState==='disconnected'){delete state.lobbyPlayers[peerId];renderLobbySlots();updatePaletteUI();}renderLobbySlots();};
        if(offerer){const ch=rtc.createDataChannel("game",{ordered:false});this.peers[peerId].ch=ch;this.setupCh(ch,peerId);rtc.createOffer().then(o=>{rtc.setLocalDescription(o);this.sig({type:'offer',sdp:o,target:peerId});});}
        else{rtc.ondatachannel=e=>{this.peers[peerId].ch=e.channel;this.setupCh(e.channel,peerId);};}
    }
    setupCh(ch,peerId){ch.onmessage=e=>onNetData(JSON.parse(e.data),peerId);ch.onopen=()=>{sendProfileUpdate();if(this.id===1)this.send({t:'lobby_sync_full',list:state.lobbyPlayers});};}
    send(d){const msg=JSON.stringify(d);for(let pid in this.peers){const p=this.peers[pid];if(p.ch&&p.ch.readyState==='open')p.ch.send(msg);}}
    broadcast(d){this.send(d);} // FIX: FunciÃ³n broadcast agregada
}

class Player{
    constructor(id,c,r,n,idx){this.id=id;this.name=n;this.colorIdx=idx;this.spawnX=c*CONFIG.TILE;this.spawnY=r*CONFIG.TILE;this.activeBombs=0;this.sentIdlePacket=true;this.stats={speed:CONFIG.SPEED_BASE,maxBombs:CONFIG.MAX_BOMBS_BASE,range:CONFIG.BOMB_RANGE_BASE};this.reset();}
    reset(){this.x=this.spawnX;this.y=this.spawnY;this.targetX=this.x;this.targetY=this.y;this.isMoving=false;this.isDead=false;this.animState='IDLE_DOWN';this.facingLeft=false;this.deadTimer=0;this.activeBombs=0;this.sentIdlePacket=true;this.stats={speed:CONFIG.SPEED_BASE,maxBombs:CONFIG.MAX_BOMBS_BASE,range:CONFIG.BOMB_RANGE_BASE};if(this.id===net.id)updateStatsUI();}
    die(){if(this.isDead)return;this.isDead=true;this.animState='DIE';this.deadTimer=90;}
    update(){
        if(this.isDead){if(this.deadTimer>0)this.deadTimer--;else if(this.deadTimer===0){this.deadTimer=-1;this.reset();if(this.id===net.id)net.send({t:'respawn',id:this.id});}return;}
        if(this.isMoving){
            if(this.id===net.id){if(this.targetY>this.y)this.animState='WALK_DOWN';else if(this.targetY<this.y)this.animState='WALK_UP';else if(this.targetX>this.x){this.animState='WALK_SIDE';this.facingLeft=false;}else if(this.targetX<this.x){this.animState='WALK_SIDE';this.facingLeft=true;}}
            const spd=this.stats.speed;
            if(this.x<this.targetX)this.x+=spd;if(this.x>this.targetX)this.x-=spd;if(this.y<this.targetY)this.y+=spd;if(this.y>this.targetY)this.y-=spd;
            if(Math.abs(this.x-this.targetX)<spd && Math.abs(this.y-this.targetY)<spd){this.x=this.targetX;this.y=this.targetY;this.isMoving=false;this.checkInput();}
        }else{if(this.id===net.id){if(this.animState==='WALK_DOWN')this.animState='IDLE_DOWN';if(this.animState==='WALK_UP')this.animState='IDLE_UP';if(this.animState==='WALK_SIDE')this.animState='IDLE_SIDE';}this.checkInput();}
    }
    checkInput(){
        if(this.id!==net.id || state.winner)return;
        const myC=Math.round(this.x/CONFIG.TILE),myR=Math.round(this.y/CONFIG.TILE);
        // Pickups logic
        const itIdx=items.findIndex(i=>i.c===myC&&i.r===myR&&!i.hidden);
        if(itIdx!==-1){
            const it=items[itIdx]; if(it.type===ITEM_TYPE.FIRE)this.stats.range++; if(it.type===ITEM_TYPE.BOMB)this.stats.maxBombs++; if(it.type===ITEM_TYPE.SPEED&&this.stats.speed<4)this.stats.speed+=0.5;
            updateStatsUI(); net.send({t:'pickup',idx:itIdx,id:this.id}); items.splice(itIdx,1);
        }
        if(state.input.active){
            let col=Math.round(this.x/CONFIG.TILE),row=Math.round(this.y/CONFIG.TILE),nextCol=col+state.input.x,nextRow=row+state.input.y;
            if(nextCol>=0&&nextCol<CONFIG.COLS&&nextRow>=0&&nextRow<CONFIG.ROWS){
                if(mapGrid[nextRow][nextCol].type===TILE_TYPE.EMPTY){
                    const b=bombs.find(x=>x.col===nextCol&&x.row===nextRow);
                    if(!b||b.exploded){
                        this.targetX=nextCol*CONFIG.TILE;this.targetY=nextRow*CONFIG.TILE;this.isMoving=true;this.sentIdlePacket=false;
                        let anim=this.animState,face=this.facingLeft;
                        if(state.input.y>0)anim='WALK_DOWN';else if(state.input.y<0)anim='WALK_UP';else if(state.input.x>0){anim='WALK_SIDE';face=false;}else if(state.input.x<0){anim='WALK_SIDE';face=true;}
                        net.send({t:'m',tx:this.targetX,ty:this.targetY,x:this.x,y:this.y,id:this.id,a:anim,f:face,s:this.stats.speed});
                    }
                }
            }
        }else if(!this.sentIdlePacket){
            let idle=this.animState; if(idle.startsWith('WALK_DOWN'))idle='IDLE_DOWN';if(idle.startsWith('WALK_UP'))idle='IDLE_UP';if(idle.startsWith('WALK_SIDE'))idle='IDLE_SIDE';
            this.animState=idle; net.send({t:'m',tx:this.x,ty:this.y,x:this.x,y:this.y,id:this.id,a:idle,f:this.facingLeft,s:this.stats.speed}); this.sentIdlePacket=true;
        }
    }
    placeBomb(){
        if(this.isDead||this.activeBombs>=this.stats.maxBombs||state.winner)return;
        const c=Math.round(this.x/CONFIG.TILE),r=Math.round(this.y/CONFIG.TILE);
        if(mapGrid[r][c].type===TILE_TYPE.BOMB)return;if(bombs.some(b=>b.col===c&&b.row===r))return;
        createBomb(c,r,this.id,this.stats.range);this.activeBombs++;net.send({t:'b',c:c,r:r,oid:this.id,rng:this.stats.range});
    }
    draw(ctx){
        if(this.isDead&&this.deadTimer<=0)return;
        const anim=SPRITES.CHAR[this.animState]; let frame=0;
        if(this.animState==='DIE') frame=Math.min(Math.floor((1-(this.deadTimer/90))*anim.length),anim.length-1); else frame=Math.floor(state.frame/10)%anim.length;
        const coord=anim[frame]||anim[0], dx=Math.floor(this.x), dy=Math.floor(this.y-8);
        ctx.save();
        if(this.facingLeft){ctx.translate(dx+CONFIG.TILE,dy);ctx.scale(-1,1);drawSprite(ctx,coord,0,0,this.colorIdx);}else drawSprite(ctx,coord,dx,dy,this.colorIdx);
        ctx.restore();
        if(!this.isDead){
            const c={0:'#ac3232',1:'#3498db',2:'#2ecc71',3:'#f1c40f',4:'#9b59b6',5:'#00cec9'};
            ctx.fillStyle=c[this.colorIdx]||'#fff'; ctx.beginPath(); ctx.moveTo(Math.floor(this.x+16),Math.floor(this.y-12)); ctx.lineTo(Math.floor(this.x+12),Math.floor(this.y-18)); ctx.lineTo(Math.floor(this.x+20),Math.floor(this.y-18)); ctx.fill();
        }
    }
}
class Bomb{constructor(c,r,o,rn){this.col=c;this.row=r;this.ownerId=o;this.range=rn;this.timer=180;this.exploded=false;} update(){if(this.exploded)return true;this.timer--;return this.timer<=0;} detonate(){this.timer=0;this.exploded=true;} draw(ctx){const f=SPRITES.BOMB_IDLE,i=Math.floor(state.frame/15)%f.length;drawSprite(ctx,f[i],this.col*CONFIG.TILE,this.row*CONFIG.TILE);}}
class Explosion{constructor(c,r,o,t){this.col=c;this.row=r;this.ownerId=o;this.timer=30;this.sprite=t==='center'?SPRITES.EXPLOSION_ANIM[0]:SPRITES.EXPLOSION_ANIM[1];} update(){this.timer--;checkPlayerHit(this.col,this.row,state.localPlayer,this.ownerId);for(let p in state.players)checkPlayerHit(this.col,this.row,state.players[p],this.ownerId);const i=items.findIndex(x=>x.c===this.col&&x.row===this.row);if(i!==-1&&!items[i].hidden)items.splice(i,1);return this.timer<=0;} draw(ctx){const f=this.timer>15?0:1;drawSprite(ctx,SPRITES.EXPLOSION_ANIM[f],this.col*CONFIG.TILE,this.row*CONFIG.TILE);}}

function checkPlayerHit(c,r,p,k){if(!p||p.isDead||state.winner)return;if(Math.round(p.x/CONFIG.TILE)===c&&Math.round(p.y/CONFIG.TILE)===r){p.die();updateScore(k,p.id);}}
function updateScore(k,v){if(state.processingDeath||state.winner)return;state.processingDeath=true;setTimeout(()=>state.processingDeath=false,500);if(k===v)state.scores[k]=Math.max(0,(state.scores[k]||0)-1);else{if(!state.scores[k])state.scores[k]=0;state.scores[k]++;}renderLobbySlots();checkWinCondition();}
function checkWinCondition(){for(let p in state.scores)if(state.scores[p]>=CONFIG.WIN_SCORE){const n=state.lobbyPlayers[p]?.name||`P${p}`;endGame(n,`LlegÃ³ a ${CONFIG.WIN_SCORE} pts`);return;}}
function endGame(w,r){state.winner=w;document.getElementById('game-over-overlay').style.display='flex';document.getElementById('winner-text').innerText=`GANADOR ${w}`;document.getElementById('winner-reason').innerText=r;}
function updateHUD(){const t=document.getElementById('timer-box');if(t){t.innerText=state.timeLeft;t.style.color=state.timeLeft<10?'#e74c3c':'#fff';}}
function drawSprite(ctx,c,x,y,idx=-1){if(!assets.loaded||!c)return;let s=assets.spritesheet;if(idx>=0&&assets.coloredSheets[idx])s=assets.coloredSheets[idx];ctx.drawImage(s,c.x*32,c.y*32,32,32,x,y,32,32);}

// --- MAIN ---
const canvas=document.getElementById('gameCanvas'),ctx=canvas.getContext('2d'),net=new Net();
window.onload=loadAssets;
function init(){ctx.imageSmoothingEnabled=false;window.addEventListener('resize',resizeViewport);setupInputs();if('ontouchstart'in window||navigator.maxTouchPoints>0)document.getElementById('gamepad-area').style.display='flex';resizeViewport();requestAnimationFrame(gameLoop);}
function connectToServer(){const r=document.getElementById('roomInput').value;if(!r)return;document.getElementById('btnConnect').disabled=true;document.getElementById('btnConnect').innerText="...";net.connect(r.toUpperCase());}
function enterLobby(id){state.status='LOBBY';document.getElementById('screen-login').style.display='none';document.getElementById('screen-lobby').style.display='flex';sendProfileUpdate();if(id===1){document.getElementById('btnStartGame').style.display='block';document.getElementById('btnStartGame').disabled=false;document.getElementById('lobby-msg').innerText="Eres el HOST.";}}
function hostStartGame(){
    if(net.id!==1)return;
    const lvl=parseInt(document.getElementById('set-level').value), den=parseFloat(document.getElementById('set-density').value);
    const itemsAllowed=[]; if(document.getElementById('chk-fire').checked)itemsAllowed.push(ITEM_TYPE.FIRE);if(document.getElementById('chk-bomb').checked)itemsAllowed.push(ITEM_TYPE.BOMB);if(document.getElementById('chk-speed').checked)itemsAllowed.push(ITEM_TYPE.SPEED);
    currentLevel=(lvl===0)?(Math.random()>0.5?2:1):lvl; generateMap(den, itemsAllowed);
    state.timeLeft=CONFIG.ROUND_TIME; net.broadcast({t:'start',grid:mapGrid,lvl:currentLevel,items:items}); beginGameLoop();
}
function beginGameLoop(){
    state.status='GAME';document.getElementById('screen-lobby').style.display='none';document.getElementById('hud-container').style.display='flex';document.getElementById('hud').style.display='flex';for(let i=1;i<=4;i++)document.getElementById(`p${i}-score`).style.display='block';
    const i=getSpawnInfo(net.id), d=state.lobbyPlayers[net.id]||{name:`P${net.id}`,colorIdx:0}; state.localPlayer=new Player(net.id,i.x,i.y,d.name,d.colorIdx);
    for(let p in state.lobbyPlayers){const pid=parseInt(p);if(pid!==net.id){const pi=getSpawnInfo(pid),pd=state.lobbyPlayers[pid];state.players[pid]=new Player(pid,pi.x,pi.y,pd.name,pd.colorIdx);}}
    updateStatsUI();
}
function onNetData(d,pid){
    const tid=d.id||pid;
    if(d.t==='profile_update'){updateLobbyData(d.id,d.name,d.cIdx,d.rdy);return;}
    if(d.t==='lobby_sync_full'){for(let p in d.list)updateLobbyData(p,d.list[p].name,d.list[p].colorIdx,d.list[p].isReady);return;}
    if(state.status==='LOBBY'&&d.t==='start'){mapGrid=d.grid;currentLevel=d.lvl;items=d.items;beginGameLoop();return;}
    if(state.status==='GAME'){
        if(d.t==='tick'){state.timeLeft=d.time;updateHUD();return;}
        if(d.t==='game_over'){const n=state.lobbyPlayers[d.winner]?.name||`P${d.winner}`;endGame(n,"Â¡Tiempo!");return;}
        if(d.t==='reset_round'){mapGrid=d.grid;currentLevel=d.lvl;items=d.items;if(state.localPlayer)state.localPlayer.reset();for(let k in state.players)state.players[k].reset();return;}
        if(d.t==='pickup'){items.splice(d.idx,1);}
        let p=state.players[tid];
        if(d.t==='m'){if(!p){const i=getSpawnInfo(tid),pd=state.lobbyPlayers[tid]||{name:`P${tid}`,colorIdx:0};state.players[tid]=new Player(tid,i.x,i.y,pd.name,pd.colorIdx);p=state.players[tid];}p.x=d.x;p.y=d.y;p.targetX=d.tx;p.targetY=d.ty;p.isMoving=true;if(d.a)p.animState=d.a;if(d.f!==undefined)p.facingLeft=d.f;if(d.s)p.stats.speed=d.s;}
        if(d.t==='b')createBomb(d.c,d.r,d.oid,d.rng);
        if(d.t==='respawn'&&p)p.reset();
    }
}
function getSpawnInfo(id){const x=(id===1||id===4)?1:CONFIG.COLS-2,y=(id===1||id===3)?1:CONFIG.ROWS-2;return{x:x,y:y};}
function generateMap(den=0.6, allowed=[1,2,3]){
    mapGrid=[];items=[];const safe=(c,r)=>(c<=2&&r<=2)||(c>=CONFIG.COLS-3&&r>=CONFIG.ROWS-3)||(c>=CONFIG.COLS-3&&r<=2)||(c<=2&&r>=CONFIG.ROWS-3);
    for(let r=0;r<CONFIG.ROWS;r++){let row=[];for(let c=0;c<CONFIG.COLS;c++){let t={type:TILE_TYPE.EMPTY};if(r===0||c===0||r===CONFIG.ROWS-1||c===CONFIG.COLS-1||(r%2===0&&c%2===0))t.type=TILE_TYPE.WALL;else if(!safe(c,r)&&Math.random()<CONFIG.BRICK_DENSITY){t.type=TILE_TYPE.BRICK;if(allowed.length>0&&Math.random()<den){const rt=allowed[Math.floor(Math.random()*allowed.length)];items.push({c:c,r:r,type:rt,hidden:true});}}row.push(t);}mapGrid.push(row);}
}
function createBomb(c,r,o,rng){mapGrid[r][c].type=TILE_TYPE.BOMB;bombs.push(new Bomb(c,r,o,rng));}
function explode(b){
    const cc=b.col,cr=b.row;if(state.localPlayer&&state.localPlayer.id===b.ownerId)state.localPlayer.activeBombs--;else if(state.players[b.ownerId])state.players[b.ownerId].activeBombs--;
    mapGrid[cr][cc].type=TILE_TYPE.EMPTY;explosions.push(new Explosion(cc,cr,b.ownerId,'center'));
    const dirs=[{x:0,y:-1},{x:0,y:1},{x:-1,y:0},{x:1,y:0}];
    dirs.forEach(d=>{for(let i=1;i<=b.range;i++){const nc=cc+d.x*i,nr=cr+d.y*i;if(nc<0||nr<0||nc>=CONFIG.COLS||nr>=CONFIG.ROWS)break;const t=mapGrid[nr][nc].type;if(t===TILE_TYPE.WALL)break;if(t===TILE_TYPE.BRICK){mapGrid[nr][nc].type=TILE_TYPE.EMPTY;const it=items.find(x=>x.c===nc&&x.r===nr);if(it)it.hidden=false;explosions.push(new Explosion(nc,nr,b.ownerId,'mid'));break;}else if(t===TILE_TYPE.BOMB){const ch=bombs.find(x=>x.col===nc&&x.row===nr&&!x.exploded);if(ch)ch.detonate();explosions.push(new Explosion(nc,nr,b.ownerId,'mid'));}else explosions.push(new Explosion(nc,nr,b.ownerId,'mid'));}});
}
function checkMapReset(){let h=false;for(let r=0;r<CONFIG.ROWS;r++)for(let c=0;c<CONFIG.COLS;c++)if(mapGrid[r][c].type===TILE_TYPE.BRICK){h=true;break;}if(!h){currentLevel=currentLevel===1?2:1;generateMap(0.25,[1,2,3]);if(state.localPlayer)state.localPlayer.reset();for(let k in state.players)state.players[k].reset();net.broadcast({t:'reset_round',grid:mapGrid,lvl:currentLevel,items:items});}}
function resizeViewport(){const h=document.getElementById('gamepad-area').style.display==='flex'?240:0;const sc=Math.min(window.innerWidth/CONFIG.WIDTH,(window.innerHeight-h-100)/CONFIG.HEIGHT);const vp=document.getElementById('game-viewport');vp.style.width=(CONFIG.WIDTH*sc)+"px";vp.style.height=(CONFIG.HEIGHT*sc)+"px";canvas.width=CONFIG.WIDTH;canvas.height=CONFIG.HEIGHT;ctx.imageSmoothingEnabled=false;}
function gameLoop(){
    state.frame++;if(state.status==='GAME'){update();draw();if(net.id===1&&!state.winner&&state.frame%60===0){state.timeLeft--;updateHUD();net.broadcast({t:'tick',time:state.timeLeft});if(state.timeLeft<=0){let max=-1,w=null;for(let p in state.scores)if(state.scores[p]>max){max=state.scores[p];w=p;}else if(state.scores[p]===max)w='EMPATE';net.broadcast({t:'game_over',winner:w||1});endGame(state.lobbyPlayers[w]?.name||w||"EMPATE","Tiempo!");}}}requestAnimationFrame(gameLoop);
}
function update(){if(state.localPlayer)state.localPlayer.update();for(let p in state.players)state.players[p].update();for(let i=bombs.length-1;i>=0;i--){if(bombs[i].update()){explode(bombs[i]);bombs.splice(i,1);if(net.id===1)checkMapReset();}}for(let i=explosions.length-1;i>=0;i--)if(explosions[i].update())explosions.splice(i,1);}
function draw(){
    ctx.imageSmoothingEnabled=false;ctx.fillStyle="#111";ctx.fillRect(0,0,canvas.width,canvas.height);
    const ts=currentLevel===1?SPRITES.L1:SPRITES.L2;
    for(let r=0;r<CONFIG.ROWS;r++)for(let c=0;c<CONFIG.COLS;c++){
        const x=c*CONFIG.TILE,y=r*CONFIG.TILE,cell=mapGrid[r][c];
        drawSprite(ctx,ts.FLOOR,x,y);
        const it=items.find(i=>i.c===c&&i.r===r);
        if(it&&!it.hidden){let s=SPRITES.ITEM_FIRE;if(it.type===ITEM_TYPE.BOMB)s=SPRITES.ITEM_BOMB;if(it.type===ITEM_TYPE.SPEED)s=SPRITES.ITEM_SPEED;const off=Math.sin(state.frame*0.1)*2;drawSprite(ctx,s,x,y+off);}
        if(cell.type===TILE_TYPE.WALL)drawSprite(ctx,ts.WALL_S,x,y);else if(cell.type===TILE_TYPE.BRICK)drawSprite(ctx,ts.WALL_B,x,y);
    }
    bombs.forEach(b=>b.draw(ctx));explosions.forEach(e=>e.draw(ctx));
    const all=[];if(state.localPlayer)all.push(state.localPlayer);for(let p in state.players)all.push(state.players[p]);all.sort((a,b)=>a.y-b.y);all.forEach(p=>p.draw(ctx));
}
function setupInputs(){const set=(x,y)=>{state.input.x=x;state.input.y=y;state.input.active=(x!==0||y!==0);};window.onkeydown=e=>{if(e.repeat)return;if(['ArrowUp','w'].includes(e.key))set(0,-1);if(['ArrowDown','s'].includes(e.key))set(0,1);if(['ArrowLeft','a'].includes(e.key))set(-1,0);if(['ArrowRight','d'].includes(e.key))set(1,0);if(e.code==='Space'&&state.localPlayer)state.localPlayer.placeBomb();};window.onkeyup=e=>{if(['ArrowUp','w','ArrowDown','s','ArrowLeft','a','ArrowRight','d'].includes(e.key))set(0,0);};const b=document.getElementById('action-btn');b.addEventListener('touchstart',e=>{e.preventDefault();if(state.localPlayer)state.localPlayer.placeBomb();},{passive:false});bindTouch('btn-up',0,-1);bindTouch('btn-down',0,1);bindTouch('btn-left',-1,0);bindTouch('btn-right',1,0);}
function bindTouch(id,x,y){const el=document.getElementById(id);el.addEventListener('touchstart',e=>{e.preventDefault();state.input.x=x;state.input.y=y;state.input.active=true;el.style.opacity="0.6";},{passive:false});el.addEventListener('touchend',e=>{e.preventDefault();state.input.active=false;el.style.opacity="1";});}
function log(t){document.getElementById('login-log').innerText=t;}
</script>
</body>
</html>